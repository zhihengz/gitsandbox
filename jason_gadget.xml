<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs>
    <Require feature="googleapis"/>
    <Require feature="views"/>
    <Require feature="locked-domain"/>
    <Require feature="flash"/>
  </ModulePrefs>
<Content view="canvas" type="html"><![CDATA[
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<div id="gameContent">
<table width="768px" height="435px" align="center" valign="center" bgcolor="black">
   <tr><td width="100%">
   <img src="http://com-ea2d-oz.s3.amazonaws.com/dal-ozdev/loading9.gif" alt="loading..."/>
   </td></tr>
</table>
</div>
<script>
  getInitialScopes = function() {
    return [ 'https://www.googleapis.com/auth/emeraldsea.circles.read',
             'https://www.googleapis.com/auth/userinfo.profile',
             'https://www.googleapis.com/auth/userinfo.email'];
  };
  
  apisAreReadyCallback = function(authorized) {
//    iframes.resize({height: 1200});
    if (authorized) {
      console.log("user is authorized, go ahead...");
      token = google.getToken();
      loadUserInfo();
    } else {
      console.log("Oops. Looks like you need to authorize this game.");
      $('#loginLink').html('Please <a href="javascript:google.doAuth(false)">click here</a> to sign in!');
    }
  };

  loadUserInfo = function() {
      google.plusone.api('/people/me', function(data) {
        // I should probably do some error checking here
        playerId = data.id;
        sendToken(playerId);
      })
  }

  serveIndexCallback = function(response){
    if (response.rc == 200) {
      console.log( response.data );
      $("#gameContent").html(response.data);
//      iframes.resize({height: document.body.scrollHeight});
    } else {
      $("#gameContent").html("<p>Hmm... got response code " + response.rc + ". Check the console log.</p>");
      console.log(response);
    }
  }

  sendToken = function(playerId) {
    var token = google.getToken();
    console.log(token);
    
    gadgets.io.makeRequest("http://ec2-184-72-143-197.compute-1.amazonaws.com:7070/controller/game/oz/1/", serveIndexCallback, {
      'METHOD': 'POST',
      'POST_DATA': gadgets.io.encodeValues({
        'token': token.access_token,
        'playerId': playerId
      })
    });
  }
</script>
<script src="https://apps.sandbox.google.com/js/appsapi.js?container=gcjs&c=2&debug=1">
{
  'appsapi': {},
  'appsutil': {
    'apis_are_ready': apisAreReadyCallback,
    'required_scopes': getInitialScopes()
  },
  'poclient': {
    'update_session': google.updateSessionCallback
  },
}
</script>
<div id="loginLink"></div>
<div id="ozDebug"></div>
]]>
</Content>
</Module>
